<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.fourclover.clobee.event.repository.EventRepository">
    <!-- 출석 이벤트 : 사용자별 출석 정보 불러오기 -->
    <select id="getTotalAttend" parameterType="long" resultType="EventAttendanceDetail">
        SELECT *
        FROM event_attendance_detail
        WHERE user_id = #{userId}
    </select>

    <!-- 출석 이벤트 : 출석 추가하기 -->
    <insert id="addAttendDay" parameterType="EventAttendanceDetail">
        INSERT INTO event_attendance_detail (event_info_id, user_id)
        VALUES (#{eventInfoId}, #{userId})
        RETURNING event_attendance_id
    </insert>

    <!-- 진행중인 이벤트 불러오기 -->
    <select id="getEventInfo" parameterType="int" resultType="EventInfo">
        SELECT *
        FROM event_info
        WHERE event_status_cd IN (702, 703)
        AND event_type_cd = #{comCodeId}
    </select>

    <!-- findClover 이벤트 정보 단건 조회 -->
    <select id="selectEventInfoByTypeCd"
            parameterType="int"
            resultType="EventInfo">
        SELECT
            event_info_id,
            event_title,
            event_desc,
            event_type_cd,
            event_start_day,
            event_end_day,
            event_status_cd,
            event_card_url,
            event_card_corp,
            event_qr,
            is_deleted,
            created_at,
            updated_at
        FROM event_info
        WHERE event_type_cd   = #{eventTypeCd}
          AND event_status_cd = 702
          AND CURRENT_DATE BETWEEN event_start_day AND event_end_day
    </select>

    <!-- 유저의 클로버 이벤트 정보 조회 -->
    <select id="selectCloverDetailByUserId"
            parameterType="long"
            resultType="EventFindingCloverDetail">
        SELECT *
        FROM event_finding_clover_detail
        WHERE user_id = #{userId}
        -- 오늘(현재 날짜) 기록만 조회하려면 아래 한 줄 추가
        AND DATE(created_at) = CURRENT_DATE
        ORDER BY created_at DESC
        LIMIT 1
    </select>

    <!--  새 기록 삽입 -->
    <insert id="insertCloverDetail"
            parameterType="com.fourclover.clobee.event.domain.EventFindingCloverDetail"
            useGeneratedKeys="true" keyProperty="eventFindingCloverId">
        INSERT INTO event_finding_clover_detail
        (event_info_id, user_id,
         event_finding_clover_participation_status,
         event_finding_clover_current_stage,
         event_finding_clover_receive_coupon,
         event_finding_clover_attempts_left,
         created_at, updated_at)
        VALUES
            (#{eventInfoId}, #{userId},
             #{eventFindingCloverParticipationStatus},
             #{eventFindingCloverCurrentStage},
             #{eventFindingCloverReceiveCoupon},
             #{eventFindingCloverAttemptsLeft},
             NOW(), NOW())
    </insert>

    <update id="updateCloverDetail"
            parameterType="com.fourclover.clobee.event.domain.EventFindingCloverDetail">
        UPDATE event_finding_clover_detail
        SET
            event_finding_clover_participation_status = #{eventFindingCloverParticipationStatus},
            event_finding_clover_current_stage        = #{eventFindingCloverCurrentStage},
            event_finding_clover_receive_coupon       = #{eventFindingCloverReceiveCoupon},
            event_finding_clover_attempts_left        = #{eventFindingCloverAttemptsLeft},
            updated_at = NOW()
        WHERE event_finding_clover_id = #{eventFindingCloverId}
    </update>
</mapper>